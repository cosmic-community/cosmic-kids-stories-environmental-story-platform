// src/pages/stories/[slug].astro
---
export interface Props {
  story: any; // TODO: Define proper type
}

import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import CosmicBadge from '@/components/CosmicBadge.astro';
import { getStoryBySlug, getAllStories } from '@/lib/cosmic';
import type { Story } from '@/types';

export async function getStaticPaths() {
  const stories = await getAllStories();
  
  return stories.map((story) => ({
    params: { slug: story.slug },
    props: { story },
  }));
}

interface Props {
  story: Story;
}

const { story } = Astro.props;

// Safe access to potentially undefined properties
const storyTitle = story.metadata?.story_title || story.title;
const storyContent = story.metadata?.story_content;
const featuredImage = story.metadata?.featured_illustration;
const ageGroup = story.metadata?.age_group;
const ecoTheme = story.metadata?.eco_theme;
const readingTime = story.metadata?.reading_time;
const moralLesson = story.metadata?.moral_lesson;

// Access environment variable on server side
const bucketSlug = import.meta.env.COSMIC_BUCKET_SLUG;
---

<Layout 
  title={`${storyTitle} - Cosmic Kids Stories`}
  description={moralLesson || `Read the eco-adventure "${storyTitle}" and learn about environmental responsibility through engaging storytelling.`}
>
  <Header />
  
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Story Header -->
    <article class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <!-- Featured Image -->
      {featuredImage && (
        <div class="aspect-[16/9] overflow-hidden">
          <img 
            src={`${featuredImage.imgix_url}?w=1200&h=675&fit=crop&auto=format,compress`}
            alt={storyTitle}
            width="600"
            height="337"
            class="w-full h-full object-cover"
          />
        </div>
      )}
      
      <div class="p-8">
        <!-- Story Meta -->
        <div class="flex flex-wrap items-center gap-3 mb-6">
          {ageGroup && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
              ðŸ‘¶ {ageGroup.metadata?.age_range || ageGroup.title}
            </span>
          )}
          {ecoTheme && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
              ðŸŒ± {ecoTheme.metadata?.theme_name || ecoTheme.title}
            </span>
          )}
          {readingTime && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
              ðŸ“– {readingTime}
            </span>
          )}
          {ageGroup?.metadata?.reading_level && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
              ðŸ“Š {ageGroup.metadata.reading_level.value} Level
            </span>
          )}
        </div>
        
        <!-- Story Title -->
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-8 leading-tight">
          {storyTitle}
        </h1>
        
        <!-- Story Content -->
        {storyContent && (
          <div class="prose prose-lg max-w-none mb-8">
            <div 
              class="story-content text-gray-800 leading-relaxed"
              set:html={storyContent}
            />
          </div>
        )}
        
        <!-- Moral Lesson -->
        {moralLesson && (
          <div class="bg-gradient-to-r from-green-50 to-blue-50 border-l-4 border-green-500 p-6 rounded-r-lg mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-2 flex items-center">
              ðŸ’¡ What We Learn
            </h3>
            <p class="text-gray-700 leading-relaxed">{moralLesson}</p>
          </div>
        )}
        
        <!-- Related Information -->
        {(ageGroup || ecoTheme) && (
          <div class="border-t border-gray-200 pt-8 mt-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Learn More</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              
              {ageGroup && (
                <div class="bg-blue-50 rounded-lg p-6">
                  <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
                    ðŸ‘¶ Age Group: {ageGroup.title}
                  </h4>
                  {ageGroup.metadata?.description && (
                    <p class="text-blue-800 text-sm mb-3">{ageGroup.metadata.description}</p>
                  )}
                  <a 
                    href={`/age-groups/${ageGroup.slug}`}
                    class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium text-sm"
                  >
                    More stories for this age
                    <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
              )}
              
              {ecoTheme && (
                <div class="bg-green-50 rounded-lg p-6">
                  <h4 class="font-semibold text-green-900 mb-2 flex items-center">
                    ðŸŒ± Theme: {ecoTheme.metadata?.theme_name || ecoTheme.title}
                  </h4>
                  {ecoTheme.metadata?.description && (
                    <p class="text-green-800 text-sm mb-3">{ecoTheme.metadata.description}</p>
                  )}
                  <a 
                    href={`/themes/${ecoTheme.slug}`}
                    class="inline-flex items-center text-green-600 hover:text-green-800 font-medium text-sm"
                  >
                    More stories about this theme
                    <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </article>
    
    <!-- Navigation -->
    <div class="flex justify-between items-center mt-8">
      <a 
        href="/"
        class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
      >
        <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Stories
      </a>
      
      <a 
        href="/stories"
        class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-blue-600 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all"
      >
        Browse All Stories
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
  </main>

  <!-- Cosmic Badge -->
  <CosmicBadge bucketSlug={bucketSlug} />
</Layout>

<style>
  .story-content h2 {
    @apply text-2xl font-bold text-gray-900 mt-8 mb-4;
  }
  
  .story-content h3 {
    @apply text-xl font-semibold text-gray-900 mt-6 mb-3;
  }
  
  .story-content p {
    @apply mb-4 text-lg leading-relaxed;
  }
  
  .story-content strong {
    @apply font-semibold text-gray-900;
  }
  
  .story-content em {
    @apply italic text-gray-700;
  }
  
  .story-content ul, .story-content ol {
    @apply mb-4 ml-6;
  }
  
  .story-content li {
    @apply mb-2 text-lg leading-relaxed;
  }
</style>